<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Toribash Bracket</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg0:#05070d;
      --bg1:#081122;
      --panel:#0b1630cc;
      --stroke:#1f2b46;
      --text:#d7e2ff;
      --muted:#8ea2cc;

      /* Toribash-y accents */
      --cyan:#22d3ee;
      --mag:#a855f7;
      --orange:#fb923c;  /* ‚Äúmatch-score‚Äù vibe */
      --win:#34d399;
      --danger:#fb7185;
    }

    html,body{height:100%;}
    body{
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(34,211,238,.15), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(168,85,247,.12), transparent 60%),
        radial-gradient(1200px 900px at 60% 120%, rgba(251,146,60,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* Subtle ‚Äúarena texture‚Äù */
    .grain{
      position:fixed; inset:0; pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      opacity:.35;
    }

    .glass{
      background: var(--panel);
      border:1px solid rgba(31,43,70,.9);
      box-shadow:
        0 20px 70px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }

    .btn{
      border:1px solid rgba(31,43,70,.9);
      background: rgba(11,22,48,.7);
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .btn:hover{ background: rgba(14,28,58,.85); }

    .btnPrimary{
      border:1px solid rgba(34,211,238,.45);
      background: linear-gradient(180deg, rgba(34,211,238,.22), rgba(34,211,238,.10));
    }
    .btnPrimary:hover{ background: linear-gradient(180deg, rgba(34,211,238,.30), rgba(34,211,238,.14)); }

    .btnOrange{
      border:1px solid rgba(251,146,60,.45);
      background: linear-gradient(180deg, rgba(251,146,60,.25), rgba(251,146,60,.10));
    }
    .btnOrange:hover{ background: linear-gradient(180deg, rgba(251,146,60,.32), rgba(251,146,60,.14)); }

    .pill{
      border:1px solid rgba(31,43,70,.9);
      background: rgba(9,16,34,.65);
    }

    /* Bracket layout */
    .bracketWrap{
      position:relative;
      overflow:auto;
      height: calc(100vh - 140px);
      border-radius: 18px;
    }
    .bracketInner{
      position:relative;
      min-height: 560px;
      padding: 22px 26px 26px 26px;
    }

    .roundCol{
      position:relative;
      width: 320px;
      flex: 0 0 320px;
    }

    .roundTitle{
      color: rgba(215,226,255,.85);
      font-weight: 700;
      letter-spacing: .04em;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 12px;
      display:flex; align-items:center; gap:10px;
    }
    .roundTitle::after{
      content:"";
      height:1px; flex:1;
      background: linear-gradient(90deg, rgba(34,211,238,.25), rgba(168,85,247,.18), transparent);
    }

    /* Match cards (Challonge-like, but Toribash-themed) */
    .matchCard{
      position:absolute;
      left:0;
      width: 320px;
      border-radius: 14px;
      border:1px solid rgba(31,43,70,.95);
      background: linear-gradient(180deg, rgba(9,16,34,.85), rgba(7,12,26,.85));
      box-shadow:
        0 10px 40px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.06);
      overflow:hidden;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .matchCard:hover{
      transform: translateY(-1px);
      border-color: rgba(34,211,238,.35);
      box-shadow:
        0 18px 60px rgba(0,0,0,.55),
        0 0 0 1px rgba(34,211,238,.10),
        inset 0 1px 0 rgba(255,255,255,.06);
    }

    .scoreStrip{
      position:absolute;
      right:0; top:0; bottom:0;
      width: 46px;
      background: linear-gradient(180deg, rgba(251,146,60,.32), rgba(251,146,60,.08));
      border-left:1px solid rgba(251,146,60,.30);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color: rgba(255,232,210,.92);
      letter-spacing:.02em;
    }

    .row{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 56px 10px 12px; /* leave space for score strip */
      border-bottom:1px solid rgba(31,43,70,.55);
    }
    .row:last-child{ border-bottom:0; }

    .seed{
      width: 34px;
      height: 22px;
      border-radius: 999px;
      border:1px solid rgba(31,43,70,.9);
      background: rgba(11,22,48,.55);
      color: rgba(215,226,255,.80);
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }

    .name{
      font-size: 14px;
      font-weight: 650;
      line-height: 1.1;
      letter-spacing:.01em;
      color: rgba(215,226,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      font-size: 11px;
      color: rgba(142,162,204,.78);
      margin-top: 2px;
    }
    .winGlow{
      color: rgba(52,211,153,.95) !important;
      text-shadow: 0 0 14px rgba(52,211,153,.20);
    }

    .metaLine{
      font-size: 11px;
      color: rgba(142,162,204,.78);
      padding: 10px 12px;
      border-top:1px solid rgba(31,43,70,.55);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    /* Drawer */
    .drawer{
      position: fixed;
      top:0; right:0;
      height:100%;
      width: min(520px, 92vw);
      transform: translateX(110%);
      transition: transform .18s ease;
      z-index: 60;
    }
    .drawer.open{ transform: translateX(0); }
    .drawerOverlay{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 55;
    }
    .drawerOverlay.open{
      opacity:1; pointer-events:auto;
    }

    /* Toast */
    .toast{
      position: fixed;
      bottom: 18px;
      right: 18px;
      z-index: 70;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(31,43,70,.9);
      background: rgba(7,12,26,.9);
      box-shadow: 0 16px 50px rgba(0,0,0,.55);
      display:none;
      font-size: 13px;
      color: rgba(215,226,255,.92);
    }

    /* Scrollbar nicer */
    .bracketWrap::-webkit-scrollbar{ height:10px; width:10px;}
    .bracketWrap::-webkit-scrollbar-thumb{ background: rgba(142,162,204,.25); border-radius: 999px;}
    .bracketWrap::-webkit-scrollbar-track{ background: rgba(0,0,0,.15);}
  </style>
</head>

<body>
<div class="grain"></div>

<header class="sticky top-0 z-50 border-b border-slate-800/60 bg-slate-950/60 backdrop-blur">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl glass flex items-center justify-center"
           style="border-color:rgba(34,211,238,.35); box-shadow:0 0 0 1px rgba(34,211,238,.10), 0 12px 40px rgba(0,0,0,.45);">
        <div class="text-sm font-black" style="color:rgba(34,211,238,.95);">TB</div>
      </div>
      <div>
        <div class="text-base font-semibold leading-tight">Toribash Bracket</div>
        <div class="text-xs" style="color:rgba(142,162,204,.85);">
          Bracket-first viewer ‚Ä¢ Toribash settings ‚Ä¢ Share link ‚Ä¢ BBCode export
        </div>
      </div>
    </div>

    <div class="ml-auto flex items-center gap-2">
      <span id="liveBadge" class="hidden pill px-2 py-1 text-xs"
            style="border-color:rgba(251,113,133,.35); color:rgba(251,113,133,.95);">
        ‚óè LIVE
      </span>

      <button id="btnOpenSetup" class="btn px-3 py-2 rounded-xl text-sm">Setup</button>
      <button id="btnShare" class="btn btnPrimary px-3 py-2 rounded-xl text-sm">Share Link</button>
      <button id="btnCopyBBCodeTop" class="btn btnOrange px-3 py-2 rounded-xl text-sm">Copy BBCode</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-5 space-y-4">

  <!-- Title / status -->
  <section class="glass rounded-2xl px-4 py-4">
    <div class="flex flex-col md:flex-row md:items-center gap-3">
      <div class="flex-1">
        <div id="statusTitle" class="text-lg font-semibold">No bracket yet</div>
        <div id="statusMeta" class="text-xs mt-1" style="color:rgba(142,162,204,.85);">
          Open Setup ‚Üí add players ‚Üí generate bracket.
        </div>
      </div>

      <div class="flex gap-2">
        <button data-view="bracket" class="viewBtn btn px-3 py-2 rounded-xl text-sm">Bracket</button>
        <button data-view="matches" class="viewBtn btn px-3 py-2 rounded-xl text-sm">Matches</button>
        <button data-view="thread" class="viewBtn btn px-3 py-2 rounded-xl text-sm">Thread</button>
      </div>
    </div>
  </section>

  <!-- Bracket viewer -->
  <section id="viewBracket" class="glass bracketWrap">
    <div class="bracketInner">
      <div id="bracketRow" class="flex gap-10"></div>
      <svg id="wires" class="absolute inset-0 pointer-events-none"></svg>
    </div>
  </section>

  <!-- Matches -->
  <section id="viewMatches" class="glass rounded-2xl p-4 hidden">
    <div class="flex items-center justify-between">
      <div class="font-semibold">Matches</div>
      <div class="text-xs" style="color:rgba(142,162,204,.85);">Tap a match to edit.</div>
    </div>
    <div id="matchesList" class="mt-3 space-y-2"></div>
  </section>

  <!-- Thread -->
  <section id="viewThread" class="glass rounded-2xl p-4 hidden">
    <div class="flex items-center justify-between">
      <div class="font-semibold">BBCode Thread</div>
      <button id="btnCopyThread" class="btn btnOrange px-3 py-2 rounded-xl text-sm">Copy BBCode</button>
    </div>
    <textarea id="threadOut" rows="16"
      class="mt-3 w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-3 outline-none font-mono text-sm"
      style="color:rgba(215,226,255,.92)"></textarea>
  </section>
</main>

<!-- Drawer overlay -->
<div id="drawerOverlay" class="drawerOverlay"></div>

<!-- Drawer -->
<aside id="drawer" class="drawer glass">
  <div class="h-full flex flex-col">
    <div class="p-4 border-b border-slate-800/70 flex items-center justify-between">
      <div>
        <div class="font-semibold">Setup</div>
        <div class="text-xs" style="color:rgba(142,162,204,.85);">Tournament settings + players</div>
      </div>
      <div class="flex gap-2">
        <button id="btnNew" class="btn px-3 py-2 rounded-xl text-sm">New</button>
        <button id="btnCloseSetup" class="btn px-3 py-2 rounded-xl text-sm">Close</button>
      </div>
    </div>

    <div class="p-4 space-y-4 overflow-auto">
      <div class="rounded-2xl border border-slate-800/80 bg-slate-950/40 p-4">
        <div class="grid grid-cols-1 gap-3">
          <label class="text-sm">
            <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Tournament Name</div>
            <input id="tName" class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none"
              placeholder="ES Aikido Bash!" />
          </label>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm">
              <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Mod</div>
              <input id="tMod" class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none"
                placeholder="aikido.tbm" />
            </label>
            <label class="text-sm">
              <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Format</div>
              <select id="tFormat" class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none">
                <option value="FT1">FT1</option>
                <option value="FT3" selected>FT3</option>
                <option value="FT5">FT5</option>
                <option value="BO3">BO3</option>
                <option value="BO5">BO5</option>
              </select>
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm">
              <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Turn Limit</div>
              <input id="tTurns" type="number" class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none"
                placeholder="150" />
            </label>
            <label class="text-sm">
              <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Round Deadline (hrs)</div>
              <input id="tDeadline" type="number" class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none"
                placeholder="24" />
            </label>
          </div>

          <label class="flex items-center gap-2 text-sm">
            <input id="tReplayReq" type="checkbox" class="accent-cyan-400" checked />
            <span style="color:rgba(215,226,255,.9);">Replay required</span>
          </label>

          <label class="text-sm">
            <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Rules / Notes</div>
            <textarea id="tRules" rows="4"
              class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none"
              placeholder="DQ if no response in 24h. Replays required for finals."></textarea>
          </label>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800/80 bg-slate-950/40 p-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Players</div>
          <div class="text-xs" style="color:rgba(142,162,204,.85);">one per line</div>
        </div>
        <textarea id="players" rows="12"
          class="mt-3 w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none font-mono text-sm"></textarea>

        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnGenerate" class="btn btnPrimary px-3 py-2 rounded-xl text-sm">Generate</button>
          <button id="btnShuffle" class="btn px-3 py-2 rounded-xl text-sm">Shuffle</button>
          <button id="btnSaveLocal" class="btn px-3 py-2 rounded-xl text-sm">Save (Local)</button>
          <button id="btnLoadLocal" class="btn px-3 py-2 rounded-xl text-sm">Load (Local)</button>
        </div>

        <div id="hint" class="mt-3 text-xs" style="color:rgba(142,162,204,.85);"></div>
      </div>
    </div>
  </div>
</aside>

<!-- Match modal -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-[80]">
  <div class="w-full max-w-xl glass rounded-2xl p-4">
    <div class="flex items-center justify-between">
      <div class="font-semibold">Edit Match</div>
      <button id="modalClose" class="btn px-3 py-2 rounded-xl text-sm">Close</button>
    </div>

    <div id="modalBody" class="mt-3 space-y-3"></div>

    <div class="mt-4 flex justify-end gap-2">
      <button id="modalSave" class="btn btnPrimary px-3 py-2 rounded-xl text-sm">Save</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/** -------------------------
 * Data model
 * ------------------------*/
const LS_KEY = "tb_tournament_v2";
let state = null;
let currentView = "bracket";

const el = (id) => document.getElementById(id);
const showToast = (msg) => {
  const t = el("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> t.style.display="none", 1600);
};

function nowISO(){ return new Date().toISOString(); }

function readMetaFromForm(){
  return {
    name: el("tName").value.trim() || "Untitled Tournament",
    mod: el("tMod").value.trim() || "unknown.tbm",
    format: el("tFormat").value,
    turns: Number(el("tTurns").value || 0) || null,
    deadlineHrs: Number(el("tDeadline").value || 0) || null,
    replayRequired: el("tReplayReq").checked,
    rules: el("tRules").value.trim(),
    updatedAt: nowISO(),
  };
}
function writeMetaToForm(meta){
  el("tName").value = meta.name || "";
  el("tMod").value = meta.mod || "";
  el("tFormat").value = meta.format || "FT3";
  el("tTurns").value = meta.turns ?? "";
  el("tDeadline").value = meta.deadlineHrs ?? "";
  el("tReplayReq").checked = !!meta.replayRequired;
  el("tRules").value = meta.rules || "";
}
function parsePlayers(text){
  const lines = text.split("\n").map(s => s.trim()).filter(Boolean);
  return lines.map((name, i) => ({ name, seed: i+1 }));
}
function shuffleArray(arr){
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a.map((p,i)=>({name:p.name, seed:i+1}));
}
function nextPow2(n){ let p=1; while(p<n) p*=2; return p; }

function makeMatch(roundIndex, matchIndex, p1, p2){
  return {
    id: `r${roundIndex}m${matchIndex}`,
    roundIndex,
    matchIndex,
    p1: p1 ? { name:p1.name, seed:p1.seed, bye:!!p1.bye } : null,
    p2: p2 ? { name:p2.name, seed:p2.seed, bye:!!p2.bye } : null,
    winner: null,
    score: { p1:null, p2:null },
    replays: [],
    notes: ""
  };
}

function generateBracket(players, meta){
  const n = players.length;
  if (n < 2) throw new Error("Need at least 2 players.");
  const size = nextPow2(n);
  const byes = size - n;

  const seeded = players.slice();
  for(let i=0;i<byes;i++) seeded.push({ name:"BYE", seed:n+i+1, bye:true });

  const firstRound = [];
  const totalMatchesR1 = size/2;
  for(let i=0;i<totalMatchesR1;i++){
    const p1 = seeded[i];
    const p2 = seeded[size-1-i];
    firstRound.push(makeMatch(0, i, p1, p2));
  }

  const rounds = [firstRound];
  let matchesInRound = totalMatchesR1;
  let r = 1;
  while(matchesInRound > 1){
    matchesInRound = matchesInRound/2;
    const round = [];
    for(let i=0;i<matchesInRound;i++){
      round.push(makeMatch(r, i, null, null));
    }
    rounds.push(round);
    r++;
  }

  const t = { meta, players: seeded.filter(p=>!p.bye), rounds };
  autoAdvanceByes(t);
  propagateAll(t);
  return t;
}

function autoAdvanceByes(t){
  const r0 = t.rounds[0];
  for(const m of r0){
    const a = m.p1, b = m.p2;
    if (a?.bye && b && !b.bye){
      m.winner="p2"; m.score={p1:0,p2:1};
    } else if (b?.bye && a && !a.bye){
      m.winner="p1"; m.score={p1:1,p2:0};
    }
  }
}
function getWinnerPlayer(match){
  if (!match.winner) return null;
  const wp = match.winner === "p1" ? match.p1 : match.p2;
  if (!wp || wp.bye) return null;
  return { name: wp.name, seed: wp.seed };
}
function propagateAll(t){
  for(let r=0;r<t.rounds.length-1;r++){
    const round = t.rounds[r];
    const next = t.rounds[r+1];
    for(let i=0;i<next.length;i++){
      const m1 = round[i*2];
      const m2 = round[i*2+1];
      next[i].p1 = m1 ? getWinnerPlayer(m1) : null;
      next[i].p2 = m2 ? getWinnerPlayer(m2) : null;
      next[i].winner = null;
      next[i].score = { p1:null, p2:null };
      next[i].replays = next[i].replays || [];
      next[i].notes = next[i].notes || "";
    }
  }
}

function escapeHtml(s){
  return (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/** -------------------------
 * Views
 * ------------------------*/
function setView(v){
  currentView = v;
  el("viewBracket").classList.toggle("hidden", v !== "bracket");
  el("viewMatches").classList.toggle("hidden", v !== "matches");
  el("viewThread").classList.toggle("hidden", v !== "thread");
  render();
}

function updateStatus(){
  if(!state){
    el("statusTitle").textContent = "No bracket yet";
    el("statusMeta").textContent = "Open Setup ‚Üí add players ‚Üí generate bracket.";
    el("liveBadge").classList.add("hidden");
    return;
  }
  const m = state.meta;
  el("statusTitle").textContent = m.name;

  const bits = [
    `Mod: ${m.mod}`,
    `Format: ${m.format}`,
    m.turns ? `Turns: ${m.turns}` : null,
    m.deadlineHrs ? `Deadline: ${m.deadlineHrs}h` : null,
    m.replayRequired ? `Replays: required` : `Replays: optional`,
    `Updated: ${new Date(m.updatedAt).toLocaleString()}`
  ].filter(Boolean);

  el("statusMeta").textContent = bits.join(" ‚Ä¢ ");
  el("liveBadge").classList.remove("hidden");
}

/** -------------------------
 * Bracket render (better spacing + SVG connectors)
 * ------------------------*/
function renderBracket(){
  const row = el("bracketRow");
  const wires = el("wires");
  row.innerHTML = "";
  wires.innerHTML = "";
  if(!state) return;

  const cardH = 102;   // match card height (2 rows + meta)
  const unit = 120;    // base vertical spacing
  const rounds = state.rounds;

  // Determine overall height based on round 0 count
  const totalHeight = Math.max(560, rounds[0].length * unit + 40);
  row.parentElement.style.minHeight = totalHeight + "px";

  // build columns + cards
  const colEls = [];
  rounds.forEach((round, rIdx)=>{
    const col = document.createElement("div");
    col.className = "roundCol";
    col.style.height = totalHeight + "px";
    col.innerHTML = `
      <div class="roundTitle">Round ${rIdx+1}</div>
    `;
    colEls.push(col);

    round.forEach((m, i)=>{
      // position formula: center of prior pair
      const top = (i * (Math.pow(2, rIdx) * unit)) + (((Math.pow(2, rIdx) - 1) / 2) * unit) + 26;
      const card = document.createElement("button");
      card.className = "matchCard text-left";
      card.style.top = top + "px";
      card.style.height = cardH + "px";
      card.onclick = ()=> openMatchModal(m.id);

      const p1 = formatPlayer(m.p1, m.winner==="p1");
      const p2 = formatPlayer(m.p2, m.winner==="p2");
      const score = (m.score.p1!=null || m.score.p2!=null) ? `${m.score.p1 ?? "-"}‚Äì${m.score.p2 ?? "-"}` : "";
      const replayCount = m.replays?.length || 0;

      card.innerHTML = `
        <div class="scoreStrip">${escapeHtml(score)}</div>
        <div class="row">${p1}</div>
        <div class="row">${p2}</div>
        <div class="metaLine">
          <div>${replayCount ? `üé• ${replayCount} replay(s)` : `‚Äî`}</div>
          <div style="color:rgba(142,162,204,.65)">${m.id}</div>
        </div>
      `;
      col.appendChild(card);
    });

    row.appendChild(col);
  });

  // SVG connectors between rounds
  // We draw from each match center to its next-round match center.
  // Coordinates need column offsets: each column is 320px wide + 40px gap (gap-10 = 40px).
  const colW = 320;
  const gap = 40;
  const leftPad = 26; // bracketInner padding left

  wires.setAttribute("width", (rounds.length * (colW + gap) + 200).toString());
  wires.setAttribute("height", totalHeight.toString());
  wires.setAttribute("viewBox", `0 0 ${rounds.length * (colW + gap) + 200} ${totalHeight}`);

  const stroke = "rgba(142,162,204,.35)";
  const glow = "rgba(34,211,238,.18)";

  for(let r=0; r<rounds.length-1; r++){
    const fromRound = rounds[r];
    const toRound = rounds[r+1];

    for(let i=0; i<fromRound.length; i++){
      const fromTop = (i * (Math.pow(2, r) * unit)) + (((Math.pow(2, r) - 1) / 2) * unit) + 26;
      const fromY = fromTop + (cardH/2);

      const toIndex = Math.floor(i/2);
      const toTop = (toIndex * (Math.pow(2, r+1) * unit)) + (((Math.pow(2, r+1) - 1) / 2) * unit) + 26;
      const toY = toTop + (cardH/2);

      const x1 = leftPad + (r * (colW + gap)) + colW;        // right edge of from column
      const x2 = leftPad + ((r+1) * (colW + gap));            // left edge of to column
      const mid = (x1 + x2) / 2;

      // path: horizontal -> curve -> horizontal
      const d = `M ${x1} ${fromY} C ${mid} ${fromY}, ${mid} ${toY}, ${x2} ${toY}`;

      wires.innerHTML += `
        <path d="${d}" stroke="${stroke}" stroke-width="2" fill="none" />
        <path d="${d}" stroke="${glow}" stroke-width="6" fill="none" opacity="0.4" />
      `;
    }
  }
}

function formatPlayer(p, isWinner){
  if(!p) return `<div class="seed">TBD</div><div><div class="name" style="color:rgba(142,162,204,.75);">TBD</div><div class="sub">waiting</div></div>`;
  if(p.bye) return `<div class="seed">BYE</div><div><div class="name" style="color:rgba(142,162,204,.75);">BYE</div><div class="sub">auto-advance</div></div>`;

  const nameClass = isWinner ? "name winGlow" : "name";
  const sub = isWinner ? "winner" : "player";
  return `
    <div class="seed">${p.seed}</div>
    <div class="min-w-0">
      <div class="${nameClass}">${escapeHtml(p.name)}</div>
      <div class="sub">${sub}</div>
    </div>
  `;
}

function renderMatches(){
  const box = el("matchesList");
  box.innerHTML = "";
  if(!state){
    box.innerHTML = `<div class="text-sm" style="color:rgba(142,162,204,.85);">No matches yet.</div>`;
    return;
  }

  state.rounds.forEach((round, rIdx)=>{
    const header = document.createElement("div");
    header.className = "mt-4 mb-2 text-sm font-semibold";
    header.style.color = "rgba(215,226,255,.9)";
    header.textContent = `Round ${rIdx+1}`;
    box.appendChild(header);

    round.forEach((m)=>{
      const row = document.createElement("button");
      row.className = "w-full text-left rounded-2xl border border-slate-800/80 bg-slate-950/40 hover:bg-slate-900/60 transition p-3";
      row.onclick = ()=>openMatchModal(m.id);

      const p1 = m.p1?.name && !m.p1?.bye ? m.p1.name : "TBD";
      const p2 = m.p2?.name && !m.p2?.bye ? m.p2.name : "TBD";
      const w = m.winner ? (m.winner==="p1"?p1:p2) : "‚Äî";
      const score = (m.score.p1!=null || m.score.p2!=null) ? `${m.score.p1 ?? "-"}‚Äì${m.score.p2 ?? "-"}` : "‚Äî";
      const rep = m.replays?.length || 0;

      row.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm font-semibold truncate">${escapeHtml(p1)} <span style="color:rgba(142,162,204,.85);">vs</span> ${escapeHtml(p2)}</div>
            <div class="text-xs mt-1" style="color:rgba(142,162,204,.85);">
              Winner: <span style="color:rgba(52,211,153,.9);">${escapeHtml(w)}</span> ‚Ä¢ Score: ${escapeHtml(score)} ‚Ä¢ üé• ${rep}
            </div>
          </div>
          <div class="text-xs" style="color:rgba(142,162,204,.65);">${m.id}</div>
        </div>
      `;
      box.appendChild(row);
    });
  });
}

function renderThread(){
  if(!state){ el("threadOut").value=""; return; }
  const shareLink = buildShareLink();
  const m = state.meta;

  const bb = [];
  bb.push(`[center][size=huge][b]${m.name}[/b][/size][/center]`);
  bb.push(``);
  bb.push(`[b]Mod:[/b] ${m.mod}`);
  bb.push(`[b]Format:[/b] ${m.format}`);
  if (m.turns) bb.push(`[b]Turn Limit:[/b] ${m.turns}`);
  if (m.deadlineHrs) bb.push(`[b]Round Deadline:[/b] ${m.deadlineHrs}h`);
  bb.push(`[b]Replays:[/b] ${m.replayRequired ? "Required" : "Optional"}`);
  bb.push(``);
  bb.push(`[b]Live Bracket:[/b] [url=${shareLink}]View Bracket[/url]`);
  bb.push(``);
  bb.push(`[quote][b]Rules / Notes[/b]\n${m.rules || "Add rules here."}\n[/quote]`);
  bb.push(``);
  bb.push(`[b]Sign-up Format:[/b]`);
  bb.push(`[code]In-Game Name:\nBelt:\nClan (optional):\nDiscord (optional):[/code]`);
  bb.push(``);
  bb.push(`[b]Participants:[/b]`);
  bb.push(`[list]`);
  state.players.forEach((p,i)=> bb.push(`[*] (${i+1}) ${p.name}`));
  bb.push(`[/list]`);

  el("threadOut").value = bb.join("\n");
}

function render(){
  updateStatus();
  if(currentView==="bracket") renderBracket();
  if(currentView==="matches") renderMatches();
  if(currentView==="thread") renderThread();
}

/** -------------------------
 * Modal (edit match)
 * ------------------------*/
let modalMatchId = null;

function findMatchById(id){
  for(const round of state.rounds){
    for(const m of round){
      if(m.id===id) return m;
    }
  }
  return null;
}

function openMatchModal(matchId){
  if(!state) return;
  const m = findMatchById(matchId);
  if(!m) return;

  modalMatchId = matchId;

  const p1 = m.p1?.bye ? null : m.p1;
  const p2 = m.p2?.bye ? null : m.p2;

  const body = el("modalBody");
  body.innerHTML = "";

  body.appendChild(kv("Match", matchId));
  body.appendChild(kv("Players", `${p1?.name || "TBD"} vs ${p2?.name || "TBD"}`));
  body.appendChild(kv("Mod", state.meta.mod));
  body.appendChild(kv("Format", state.meta.format));

  body.appendChild(htmlBlock(`
    <div>
      <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Winner</div>
      <select id="mwinner" class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none">
        <option value="">Not set</option>
        <option value="p1">${p1 ? `${p1.name} (seed ${p1.seed})` : "P1 TBD"}</option>
        <option value="p2">${p2 ? `${p2.name} (seed ${p2.seed})` : "P2 TBD"}</option>
      </select>
    </div>
  `));

  body.appendChild(htmlBlock(`
    <div class="grid grid-cols-2 gap-3">
      <label>
        <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Score P1</div>
        <input id="ms1" type="number" class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none" placeholder="0">
      </label>
      <label>
        <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Score P2</div>
        <input id="ms2" type="number" class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none" placeholder="0">
      </label>
    </div>
  `));

  body.appendChild(htmlBlock(`
    <div>
      <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Replay links (one per line)</div>
      <textarea id="mreplays" rows="4"
        class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none font-mono text-sm"
        placeholder="https://..."></textarea>
    </div>
  `));

  body.appendChild(htmlBlock(`
    <div>
      <div class="text-xs mb-1" style="color:rgba(142,162,204,.85);">Host notes</div>
      <textarea id="mnotes" rows="3"
        class="w-full rounded-xl bg-slate-950/60 border border-slate-800/80 px-3 py-2 outline-none"
        placeholder="DQ / scheduling notes / disputes..."></textarea>
    </div>
  `));

  el("mwinner").value = m.winner || "";
  el("ms1").value = m.score.p1 ?? "";
  el("ms2").value = m.score.p2 ?? "";
  el("mreplays").value = (m.replays || []).join("\n");
  el("mnotes").value = m.notes || "";

  el("modal").classList.remove("hidden");
  el("modal").classList.add("flex");
}

function closeModal(){
  el("modal").classList.add("hidden");
  el("modal").classList.remove("flex");
  modalMatchId = null;
}

function saveModal(){
  if(!state || !modalMatchId) return;
  const m = findMatchById(modalMatchId);
  if(!m) return;

  const w = el("mwinner").value || null;
  const s1 = el("ms1").value === "" ? null : Number(el("ms1").value);
  const s2 = el("ms2").value === "" ? null : Number(el("ms2").value);
  const reps = el("mreplays").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const notes = el("mnotes").value.trim();

  if ((w==="p1" && (!m.p1 || m.p1.bye)) || (w==="p2" && (!m.p2 || m.p2.bye))) {
    showToast("Cannot set winner: player is TBD/BYE");
    return;
  }

  m.winner = w;
  m.score = { p1:s1, p2:s2 };
  m.replays = reps;
  m.notes = notes;
  state.meta.updatedAt = nowISO();

  propagateAll(state);
  saveLocalSilently();
  render();
  closeModal();
  showToast("Match updated");
}

function kv(k,v){
  const d = document.createElement("div");
  d.className = "text-sm";
  d.innerHTML = `<span style="color:rgba(142,162,204,.85);">${escapeHtml(k)}:</span> <span>${escapeHtml(String(v))}</span>`;
  return d;
}
function htmlBlock(html){
  const d = document.createElement("div");
  d.innerHTML = html;
  return d;
}

/** -------------------------
 * Persistence + share link
 * ------------------------*/
function saveLocalSilently(){
  if(!state) return;
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function saveLocal(){ saveLocalSilently(); showToast("Saved locally"); }
function loadLocal(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw){ showToast("No saved tournament found"); return; }
  try{
    state = JSON.parse(raw);
    hydrateFormFromState();
    render();
    showToast("Loaded");
  }catch{ showToast("Failed to load"); }
}
function clearState(){
  state = null;
  el("players").value = "";
  writeMetaToForm({name:"",mod:"",format:"FT3",turns:null,deadlineHrs:null,replayRequired:true,rules:"",updatedAt:nowISO()});
  render();
  showToast("New tournament");
}
function hydrateFormFromState(){
  if(!state) return;
  writeMetaToForm(state.meta);
  el("players").value = state.players.map(p=>p.name).join("\n");
}
function encodeStateToHash(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64;
}
function decodeStateFromHash(hash){
  const b64 = hash.replace(/^#/, "");
  const json = decodeURIComponent(escape(atob(b64)));
  return JSON.parse(json);
}
function buildShareLink(){
  const base = location.href.split("#")[0];
  if(!state) return base;
  return `${base}#${encodeStateToHash(state)}`;
}
async function shareLink(){
  if(!state){ showToast("Nothing to share yet"); return; }
  const link = buildShareLink();
  try{ await navigator.clipboard.writeText(link); showToast("Share link copied"); }
  catch{ prompt("Copy this link:", link); }
}

/** -------------------------
 * Generate + helpers
 * ------------------------*/
function generateFromForm(){
  const meta = readMetaFromForm();
  let players = parsePlayers(el("players").value);

  if(players.length < 2){ showToast("Add at least 2 players"); return; }

  const size = nextPow2(players.length);
  const byes = size - players.length;
  el("hint").textContent = byes ? `Bracket size: ${size}. BYEs: ${byes} (auto-advanced).` : `Bracket size: ${size} (perfect).`;

  try{
    state = generateBracket(players, meta);
    saveLocalSilently();
    render();
    showToast("Bracket generated");
  }catch(e){
    showToast(e.message || "Failed to generate");
  }
}
function shuffleSeeds(){
  const players = parsePlayers(el("players").value);
  if(players.length < 2){ showToast("Add players first"); return; }
  const shuffled = shuffleArray(players);
  el("players").value = shuffled.map(p=>p.name).join("\n");
  showToast("Shuffled");
}

/** -------------------------
 * Drawer controls
 * ------------------------*/
function openDrawer(){
  el("drawer").classList.add("open");
  el("drawerOverlay").classList.add("open");
}
function closeDrawer(){
  el("drawer").classList.remove("open");
  el("drawerOverlay").classList.remove("open");
}

/** -------------------------
 * Wire up UI events
 * ------------------------*/
el("btnOpenSetup").addEventListener("click", openDrawer);
el("btnCloseSetup").addEventListener("click", closeDrawer);
el("drawerOverlay").addEventListener("click", closeDrawer);

document.querySelectorAll(".viewBtn").forEach(btn=>{
  btn.addEventListener("click", ()=> setView(btn.dataset.view));
});

el("btnGenerate").addEventListener("click", generateFromForm);
el("btnShuffle").addEventListener("click", shuffleSeeds);
el("btnSaveLocal").addEventListener("click", saveLocal);
el("btnLoadLocal").addEventListener("click", loadLocal);
el("btnNew").addEventListener("click", clearState);

el("btnShare").addEventListener("click", shareLink);

function copyBBCode(){
  setView("thread");
  setTimeout(async ()=>{
    try{
      await navigator.clipboard.writeText(el("threadOut").value);
      showToast("BBCode copied");
    } catch {
      showToast("Copy failed");
    }
  }, 60);
}
el("btnCopyBBCodeTop").addEventListener("click", copyBBCode);
el("btnCopyThread").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(el("threadOut").value); showToast("BBCode copied"); }
  catch{ showToast("Copy failed"); }
});

el("modalClose").addEventListener("click", closeModal);
el("modalSave").addEventListener("click", saveModal);
el("modal").addEventListener("click", (e)=> { if(e.target === el("modal")) closeModal(); });

/** -------------------------
 * Boot
 * ------------------------*/
function boot(){
  // 1) hash
  if(location.hash && location.hash.length > 10){
    try{
      state = decodeStateFromHash(location.hash);
      hydrateFormFromState();
      saveLocalSilently();
      showToast("Loaded from shared link");
    } catch {}
  }

  // 2) local
  if(!state){
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      try{
        state = JSON.parse(raw);
        hydrateFormFromState();
      } catch {}
    } else {
      // default Toribash-ish sample
      writeMetaToForm({
        name:"ES Aikido Bash!",
        mod:"aikido.tbm",
        format:"FT3",
        turns:150,
        deadlineHrs:24,
        replayRequired:true,
        rules:"‚Ä¢ FT3 unless specified\n‚Ä¢ If no response in 24h: DQ\n‚Ä¢ Replays required for finals",
        updatedAt: nowISO()
      });
      el("players").value = "Nicotine\nNinjaBee\nMora\nDuwap\nMahoraga\nHater\nHampus\nAxels";
    }
  }

  setView("bracket");
  render();
}
boot();
</script>
</body>
</html>

